# server.js ëª¨ë“ˆ ë¶„ë¦¬ ê³„íš

server.jsê°€ 1,500ì¤„ ì´ìƒìœ¼ë¡œ ë¹„ëŒ€í•´ì ¸ì„œ ë…ë¦½ ëª¨ë“ˆë¡œ ë¶„ë¦¬ ê°€ëŠ¥í•œ ì˜ì—­ì„ ì •ë¦¬í•œë‹¤.

## ì™„ë£Œ

| ëª¨ë“ˆ        | íŒŒì¼            | ì˜ì¡´ì„±                     | Phase |
| ----------- | --------------- | -------------------------- | ----- |
| ì—…ë¡œë“œ í—¬í¼ | `lib/upload.js` | fs, https, path (ìˆœìˆ˜ I/O) | 10    |

## ë¶„ë¦¬ ê°€ëŠ¥ í›„ë³´

### 1. `lib/telegram.js` â€” Telegram Bot ì „ì²´
- **ëŒ€ìƒ**: `initTelegram()`, `tgOrchestrate()`, `markdownToTelegramHtml()`, `chunkTelegramMessage()`, `orchestrateAndCollect()`
- **í˜„ìž¬ ì¤„ìˆ˜**: ~150ì¤„ (L1252~L1420)
- **ë‚œì´ë„**: ðŸŸ¡ ì¤‘ê°„
- **ì˜ì¡´ì„±**: `broadcast`, `insertMessage`, `settings`, `telegramBot`, `telegramActiveChatIds`
- **ë°©ë²•**: ì˜ì¡´ì„± ì£¼ìž… íŒ¨í„´ â€” `initTelegram({ broadcast, insertMessage, getSettings, orchestrate })`

### 2. `lib/heartbeat.js` â€” Heartbeat ìŠ¤ì¼€ì¤„ëŸ¬
- **ëŒ€ìƒ**: `loadHeartbeatFile()`, `saveHeartbeatFile()`, `startHeartbeat()`, `stopHeartbeat()`, `runHeartbeatJob()`, `fs.watch()` ë¦¬ìŠ¤ë„ˆ
- **í˜„ìž¬ ì¤„ìˆ˜**: ~100ì¤„ (L1422~L1515)
- **ë‚œì´ë„**: ðŸŸ¡ ì¤‘ê°„
- **ì˜ì¡´ì„±**: `orchestrateAndCollect`, `telegramBot`, `settings`
- **ë°©ë²•**: `new Heartbeat({ filePath, orchestrate, sendTelegram })`

### 3. `lib/agent.js` â€” CLI Agent Spawn Engine
- **ëŒ€ìƒ**: `spawnAgent()`, `extractFromEvent()`, `extractSessionId()`, `extractToolLabel()`
- **í˜„ìž¬ ì¤„ìˆ˜**: ~400ì¤„ (ì „ì²´ì˜ 1/3)
- **ë‚œì´ë„**: ðŸ”´ ë†’ìŒ
- **ì˜ì¡´ì„±**: `activeProcess`, `broadcast`, `insertMessage`, `updateSession`, `getSystemPrompt`, `settings`, DB queries ë‹¤ìˆ˜
- **ë°©ë²•**: í´ëž˜ìŠ¤ ê¸°ë°˜ â€” `new AgentSpawner({ db, broadcast, settings })`
- **ì£¼ì˜**: spawnAgent ë‚´ë¶€ì—ì„œ DB ì§ì ‘ ì¡°ìž‘ + broadcastê°€ ë§Žì•„ì„œ ê°€ìž¥ í° ë¦¬íŒ©í† ë§

### 4. `lib/orchestrator.js` â€” Orchestration Logic
- **ëŒ€ìƒ**: `orchestrate()`, `distributeAndWait()`, `parseSubtasks()`, `stripSubtaskJSON()`
- **í˜„ìž¬ ì¤„ìˆ˜**: ~100ì¤„ (L950~L1050)
- **ë‚œì´ë„**: ðŸŸ¡ ì¤‘ê°„
- **ì˜ì¡´ì„±**: `spawnAgent`, `broadcast`, `insertMessage`, `getEmployees`, `settings`
- **ë°©ë²•**: `spawnAgent`ì™€ í•¨ê»˜ ë¶„ë¦¬í•˜ë©´ ê¹”ë”

### 5. `lib/memory.js` â€” Memory Flush
- **ëŒ€ìƒ**: `triggerMemoryFlush()`, `getMemoryDir()`, `loadRecentMemories()`
- **í˜„ìž¬ ì¤„ìˆ˜**: ~60ì¤„
- **ë‚œì´ë„**: ðŸŸ¢ ì‰¬ì›€
- **ì˜ì¡´ì„±**: `spawnAgent`, `getMessages`, `settings`
- **ë°©ë²•**: `flush({ messages, spawnAgent, settings })`

### 6. `lib/db.js` â€” Database Setup + Prepared Statements
- **ëŒ€ìƒ**: DB ì´ˆê¸°í™”, í…Œì´ë¸” ìƒì„±, prepared statements (`insertMessage`, `getMessages`, `updateSession` ë“±)
- **í˜„ìž¬ ì¤„ìˆ˜**: ~80ì¤„
- **ë‚œì´ë„**: ðŸŸ¢ ì‰¬ì›€
- **ì˜ì¡´ì„±**: better-sqlite3, íŒŒì¼ ê²½ë¡œë§Œ
- **ë°©ë²•**: `export const db = setupDb(DB_PATH)` â†’ prepared statementsë„ export

## ì¶”ì²œ ìˆœì„œ

1. `lib/db.js` (ê°€ìž¥ ë…ë¦½ì , íŒŒê¸‰ ë„“ìŒ)
2. `lib/memory.js` (DB ë¶„ë¦¬ í›„ ìžì—°ìŠ¤ëŸ½ê²Œ)
3. `lib/telegram.js` + `lib/heartbeat.js` (ì˜ì¡´ì„± ì£¼ìž… íŒ¨í„´ ë™ì¼)
4. `lib/orchestrator.js` + `lib/agent.js` (ë§ˆì§€ë§‰, ê°€ìž¥ ë³µìž¡)

> ì „ë¶€ ë¶„ë¦¬í•˜ë©´ server.jsëŠ” ~200ì¤„ (Express setup + API routes + ê¸€ë£¨ ì½”ë“œ)ë¡œ ì¤„ì–´ë“¦
