# Working Directory Refactor — Default `~` -> `~/.cli-jaw`

**Date**: 2026-02-26
**Status**: Plan + Source Validation Complete (NO CODE)
**Priority**: High (prevents instruction pollution for standalone CLI users)

---

## Problem

Current defaults use `~/` (user home) as the working directory.
That means:

1. `~/AGENTS.md` is generated in user's home — visible to ALL CLI tools
2. `~/CLAUDE.md` symlink → `~/AGENTS.md` also exists
3. Agent process `cwd` starts at `~/`
4. A-2 template says `Working Directory: ~/`

### The Real Issue: Instruction Pollution

When users run Claude, Codex, or Copilot **standalone** (outside cli-jaw) in any
directory like `~/Developer/my-app/`, these CLIs **walk up the directory tree** and
discover `~/AGENTS.md` or `~/CLAUDE.md`. This causes the standalone CLI to load
the full Jaw Agent system prompt — "I am Jaw Agent, a system-level AI assistant..."
— even when the user never intended to use cli-jaw.

This pollutes every standalone Claude/Codex/Copilot session on the machine.

## How Each CLI Receives Instructions

### From cli-jaw code (spawn.ts / args.ts)

| CLI | Method | cwd-dependent? |
|-----|--------|---------------|
| Claude | `--append-system-prompt` (CLI argument) | ❌ No |
| Gemini | `GEMINI_SYSTEM_MD` env var → tmp file | ❌ No |
| Codex | None — reads `AGENTS.md` from cwd | ✅ Yes |
| Copilot | None — reads `AGENTS.md` from cwd (ACP) | ✅ Yes |
| OpenCode | prompt argument | ❌ No |

### CLI's own built-in behavior (independent of cli-jaw)

| CLI | Auto-discovery | Walks up dirs? | Affected by ~/AGENTS.md? |
|-----|---------------|----------------|--------------------------|
| Claude CLI | Reads `CLAUDE.md`, `AGENTS.md` from cwd + parents | ✅ Yes | ✅ **Polluted** |
| Codex CLI | Reads `AGENTS.md` from cwd + parents | ✅ Yes | ✅ **Polluted** |
| Copilot CLI | Reads `AGENTS.md` from cwd + parents | ✅ Yes | ✅ **Polluted** |
| Gemini CLI | Uses `GEMINI_SYSTEM_MD` env only | ❌ No | ❌ Safe |
| OpenCode CLI | TBD — needs verification | ❓ | ❓ |

**Key insight:** Even though cli-jaw passes Claude instructions via `--append-system-prompt`
(not file-based), Claude CLI **independently** reads `~/CLAUDE.md` and `~/AGENTS.md`.
So the pollution happens at the CLI level, not the cli-jaw level.

## Proposed Change

Change default `workingDir` from `~/` to `~/.cli-jaw`.

### Why This Fixes The Pollution

- `AGENTS.md` moves from `~/AGENTS.md` to `~/.cli-jaw/AGENTS.md`
- Hidden directory `.cli-jaw` is NOT traversed by CLI parent-directory walks
  (CLIs stop at repo root or home, they don't descend into dotfiles)
- Standalone `claude` in `~/Developer/my-app/` walks up → finds nothing → clean session
- cli-jaw spawn uses `cwd: ~/.cli-jaw` → finds `AGENTS.md` → works normally

### Additional Cleanup Needed

- Remove `~/AGENTS.md` (generated by old default)
- Remove `~/CLAUDE.md` symlink (points to ~/AGENTS.md)
- Add cleanup logic to postinstall or init (one-time migration)

---

## Affected Files & Diffs

1. `PATCH-1_default_workdir.md` (2 files: config.ts, init.ts)
2. `PATCH-2_a2_template.md` (1 file: builder.ts)
3. **PATCH-3** (new): Home cleanup — remove stale `~/AGENTS.md` + `~/CLAUDE.md`

---

## Risk Assessment

| Risk | Level | Mitigation |
|------|-------|------------|
| Existing users with saved `workingDir: ~/` | None | `loadSettings()` merges; saved value wins |
| AGENTS.md path shifts | Low | CLIs read from cwd; cwd follows `settings.workingDir` |
| Agent can't access `~/` | None | Full-permission mode; absolute paths work |
| Stale `~/AGENTS.md` left behind | Medium | Add one-time cleanup in init/postinstall |
| `~/CLAUDE.md` symlink left behind | Medium | Delete symlink during migration |

## Migration

- Existing users: keep their persisted `settings.workingDir`
- One-time cleanup: remove `~/AGENTS.md` + `~/CLAUDE.md` if they point to jaw content
- New installs: default to `~/.cli-jaw`

---

## Source Validation Snapshot

Checked against current source (2026-02-26):

- `src/core/config.ts:101` -> `workingDir: os.homedir()` (to be patched)
- `bin/commands/init.ts:45-46` -> init default uses `settings.workingDir || os.homedir()` (to be patched)
- `src/prompt/builder.ts:194-211` -> `A2_DEFAULT` has `- ~/` (to be patched)
- `src/prompt/builder.ts:547-548` -> AGENTS is written to `join(settings.workingDir || os.homedir(), 'AGENTS.md')`
- `src/agent/spawn.ts:465` -> CLI spawn uses `cwd: settings.workingDir`
