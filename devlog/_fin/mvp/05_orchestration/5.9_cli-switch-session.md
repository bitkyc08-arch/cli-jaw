# Phase 5.9: CLI 전환 세션 무효화 + CLI 호환성 수정

## 5.9a: CLI 전환 세션 무효화

**문제**: codex → claude 전환 시 codex session_id로 claude `--resume` 시도 → 실패
**수정**: `PUT /api/settings`에서 CLI 변경 감지 → `session_id = null`

## 5.9b: Gemini 시스템 프롬프트

**문제**: gemini CLI에 `--system-instruction` 없음. `-p`에 넣으면 user message로 노출
**수정**: `GEMINI_SYSTEM_MD` 환경변수 (공식 방법)
- 시스템 프롬프트를 temp 파일에 쓰고 env var로 전달
- sub-agent는 개별 temp 파일 (`/tmp/claw-gemini-sys-{agentId}.md`)
- `-p`는 user prompt만 포함

> 출처: [Gemini CLI Docs](https://geminicli.com) — GEMINI_SYSTEM_MD replaces built-in system prompt

### 5.9b.1: 확인 완료

```
Before: {"role":"user","content":"# Claw Agent\nYou are Claw Agent..."}  ← 시스템 프롬프트 노출
After:  {"role":"user","content":"다시 내려왔는지 확인"}                    ← 유저 메시지만
```

`GEMINI_SYSTEM_MD` → temp 파일 → gemini가 시스템 프롬프트로 분리 처리. ✅

## 5.9c: OpenCode JSON 파싱

**문제**: `event.content` 참조하지만 실제 필드는 `event.part.text`
**수정**: `extractFromEvent` opencode 전면 교체: `part.text`, `step_finish.tokens`

## 5.9d: Exit 0 + 빈 텍스트

**문제**: exit 0인데 텍스트 없으면 에러 표시
**수정**: `code !== 0` 조건 추가

## 5.9e: skipStdin 정리

gemini (GEMINI_SYSTEM_MD 사용) + opencode (args 사용) + codex resume → stdin 스킵
