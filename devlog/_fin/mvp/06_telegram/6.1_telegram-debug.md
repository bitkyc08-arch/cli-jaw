# 6.1 Telegram 디버그 — 설정 reinit + polling 수신

## 버그 2개

### 1. Settings 저장 시 봇 갱신 안 됨

**원인**: PUT `/api/settings` 의 deep merge 루프가 `req.body.telegram`을 `delete`한 후, reinit 체크(`if (req.body.telegram)`)에서 항상 `false`.

```diff
 app.put('/api/settings', (req, res) => {
     const prevCli = settings.cli;
+    const hasTelegramUpdate = !!req.body.telegram; // capture before delete
     // Deep merge...
     delete req.body[key]; // telegram 삭제됨
     ...
-    if (req.body.telegram) initTelegram(); // 항상 false!
+    if (hasTelegramUpdate) initTelegram(); // ✅
```

### 2. 메시지 수신 안 됨 (서버 로그 zero)

**원인 후보 & 수정**:

| 수정                         | 설명                                                    |
| ---------------------------- | ------------------------------------------------------- |
| `drop_pending_updates: true` | 이전 stale updates가 polling 블로킹                     |
| `.catch()` 추가              | `bot.start()` 에러가 `bot.catch()`에 삼켜져 silent fail |
| debug 미들웨어               | `[tg:update]` 로그로 수신 여부 즉시 확인                |
| `onStart` 콜백               | `[tg] ✅ Bot @username polling active` — 정상 시작 확인  |

```js
bot.start({
    drop_pending_updates: true,
    onStart: (botInfo) => console.log(`[tg] ✅ Bot @${botInfo.username} polling active`),
}).catch(err => {
    console.error(`[tg] ❌ Bot failed to start:`, err.message || err);
});
```

## 커밋

- `3ee551e` — fix: telegram reinit flag, drop_pending_updates, error surfacing, debug middleware
