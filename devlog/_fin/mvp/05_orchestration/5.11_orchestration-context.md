# Phase 5.11: 오케스트레이션 결과가 기획 세션에 안 들어가는 문제

## 현상

1. 유저: "QA한테 인사해"
2. 기획(gemini resume): subtasks JSON 출력
3. QA(claude forceNew): "안녕하세요!" 응답
4. 평가(gemini forceNew): "완료" 판정 → DB 저장
5. 유저: "걔가 뭐라냐"
6. 기획(gemini resume): "아직 결과를 못 받았습니다" ← **버그**

## 원인

- 평가는 `forceNew: true` → 별도 gemini 인스턴스
- 기획의 resume 세션에는 라운드 결과가 전혀 없음
- DB에는 저장되지만, gemini resume은 CLI 세션 컨텍스트만 사용

## 수정 계획

### 옵션 A: 오케스트레이션 후 세션 무효화 (간단)

기획 + 오케스트레이션 완료 후 `session_id = null` → 다음 메시지에서 새 세션 시작.
새 세션은 DB 히스토리(`getRecentMessages`)를 받으므로 결과 포함.

```js
// orchestrate() 완료 후
updateSession.run(cli, null, ...);  // 세션 무효화
```

**장점**: 간단, DB 히스토리로 자연스럽게 컨텍스트 전달
**단점**: 오케스트레이션할 때마다 세션 리셋 (긴 대화 손실)

### 옵션 B: DB 히스토리를 resume에도 주입 (이상적)

gemini/opencode resume 시에도 최근 메시지를 `-p`에 포함:

```js
// 현재: resume은 user prompt만
// 수정: resume에도 최근 히스토리 포함
const recent = getRecentMessages.all(3).reverse();
const context = recent.map(...).join('\n');
const fullPrompt = `[최근 대화]\n${context}\n\n${prompt}`;
```

**장점**: 세션 유지 + 히스토리 주입
**단점**: 토큰 낭비 가능

### 추천: 옵션 A (간단)

## 체크리스트

- [ ] `orchestrate()` 완료 후 세션 무효화
- [ ] sub-agent 결과도 DB에 저장 (확인 필요)
