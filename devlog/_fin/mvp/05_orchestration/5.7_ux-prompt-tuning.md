# Phase 5.7: 오케스트레이션 UX + 프롬프트 튜닝

## 현재 문제

### 1. UI가 멍함
- "🎯 작업 분배 중..." 이후 아무 표시 없음
- sub-agent가 뭘 하는지, 몇 라운드인지 모름
- 최종 결과만 갑자기 뜨거나 아예 안 뜸

### 2. 3라운드 실패 시 무응답
- `orchestrate()` while 루프가 `MAX_ROUNDS` 도달하면 그냥 종료
- 사용자에게 아무 메시지도 안 감

### 3. 평가 에이전트 과잉 디스패치
- 단순 인사 → QA가 "안녕하세요" 응답 → 평가가 "미완료" 판정 → 재디스패치
- 평가 프롬프트가 너무 엄격해서 단순 작업도 3라운드 소진

---

## 수정 계획

### A. UI 중간 표시 (프론트엔드)

WS 이벤트를 더 세분화해서 프론트에서 표시:

```js
// 이미 있는 이벤트:
// round_start  → "🔄 라운드 {n} 시작 — {subtasks.length}개 작업"
// agent_status → "{agentName} 작업 중..."
// round_done   → "✅ 라운드 {n} 완료" 또는 "🔄 재시도"

// 프론트에서 chat-messages에 시스템 메시지로 표시
```

**체크리스트:**
- [ ] 프론트: `round_start` 이벤트 → 시스템 메시지 버블 추가
- [ ] 프론트: sub-agent `agent_status(running)` → "👷 {agentName} 작업 중..." 표시
- [ ] 프론트: sub-agent `agent_status(done)` → "✅ {agentName} 완료" 표시
- [ ] 프론트: `round_done` → 라운드 결과 요약 표시

### B. 3라운드 실패 시 폴백 메시지 (서버)

```js
// orchestrate() while 루프 이후:
if (round > MAX_ROUNDS) {
    const fallbackMsg = '⚠️ 최대 라운드(3)에 도달했습니다. 마지막 결과를 요약합니다:\n\n' + 
        results.map(r => `- ${r.name}: ${r.text.slice(0, 200)}`).join('\n');
    insertMessage.run('assistant', fallbackMsg, 'orchestrator', '');
    broadcast('agent_done', { text: fallbackMsg });
}
```

**체크리스트:**
- [ ] `orchestrate()` — MAX_ROUNDS 초과 시 fallback 메시지 저장+브로드캐스트

### C. 평가 프롬프트 완화 (서버)

현재 reportPrompt가 너무 모호해서 평가가 항상 "미완료" 판정.

```js
const reportPrompt = `## 결과 보고 (라운드 ${round})
${report}

위 결과를 평가하세요.
- sub-agent가 작업을 수행하고 결과를 보고했으면 → 완료로 판정
- 단순한 질문/인사 작업은 응답 자체가 결과입니다
- 완료: 사용자에게 보여줄 자연어 요약을 작성 (JSON 출력 금지)
- 미완료: 구체적 사유와 함께 JSON subtasks 재출력`;
```

**체크리스트:**
- [ ] `orchestrate()` — reportPrompt 개선 (완료 기준 명확화)

---

## 전체 체크리스트

- [ ] A: 프론트엔드 round/agent 상태 표시
- [ ] B: MAX_ROUNDS 초과 fallback 메시지
- [ ] C: 평가 프롬프트 완화
