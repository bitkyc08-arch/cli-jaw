# 12.1.8 Web UI 새로고침 시 상태 복원

## 문제

```
에이전트 작업 중 → 사용자가 F5 새로고침
  → WebSocket 재연결 → 이전 agent_status 이벤트 수신 못함
  → UI가 idle로 표시 (실제로는 작업 중)
```

## 해결

### 1. `GET /api/agent-status` 엔드포인트 추가

```javascript
// server.js
app.get('/api/agent-status', (_, res) => {
    res.json({
        running: !!activeProcess,
        agentId: activeProcess ? currentAgentId : null,
        queueLength: messageQueue.length,
    });
});
```

### 2. Web UI — 페이지 로드 시 상태 조회

```javascript
// index.html — connectWS() 또는 loadMessages() 후
async function loadAgentStatus() {
    try {
        const s = await (await fetch('/api/agent-status')).json();
        if (s.running) {
            agentBusy = true;
            setStatus('running');
        }
        if (s.queueLength > 0) {
            updateQueueBadge(s.queueLength);
        }
    } catch { }
}
```

### 3. WS 연결 직후 자동 상태 브로드캐스트 (대안)

```javascript
// server.js — ws connection 이벤트에서
ws.on('connection', (wsClient) => {
    // 기존 코드...
    // 연결 즉시 현재 상태 전송
    if (activeProcess) {
        wsClient.send(JSON.stringify({
            type: 'agent_status',
            status: 'running',
            agentId: currentAgentId,
        }));
    }
    if (messageQueue.length > 0) {
        wsClient.send(JSON.stringify({
            type: 'queue_update',
            pending: messageQueue.length,
        }));
    }
});
```

> 방법 3이 가장 깔끔 — API 추가 없이 WS 연결 시 자동 상태 전송

## 체크리스트

- [ ] server.js — WS 연결 시 현재 agent 상태 즉시 전송
- [ ] (선택) GET /api/agent-status 엔드포인트
- [ ] index.html — 상태 복원 UI 반영
