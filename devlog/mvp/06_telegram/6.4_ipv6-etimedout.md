# 6.4 IPv6 ETIMEDOUT — Node.js DNS 해석 문제

## 증상

`bot.start()` 호출 후 `onStart` 콜백이 **영원히 안 불림**. 서버는 동작하지만 telegram 봇 초기화 무한 대기.

## 디버깅 과정

### 1단계: bot.init() 분리 시도
```
[tg] Validating token...
(무한 대기)
```
`await bot.init()` (getMe API 호출)이 resolve도 reject도 안 됨.

### 2단계: apiThrottler 의심
throttler를 init 후로 이동 → 동일 hang. throttler는 원인 아님.

### 3단계: networkconnectivity 테스트

| 방법                       | 결과             | 시간    |
| -------------------------- | ---------------- | ------- |
| `curl getMe`               | ✅ 성공           | ~1초    |
| Node.js `fetch`            | ❌ `fetch failed` | 293ms   |
| `node-fetch`               | ❌ `ETIMEDOUT`    | timeout |
| `node-fetch` + `ipv4first` | ❌ `ETIMEDOUT`    | timeout |
| `https.get({family: 4})`   | ✅ 성공           | 820ms   |

### 4단계: 핵심 발견

```js
// ❌ FAIL — Node.js 기본 (IPv6 우선)
const r = await fetch('https://api.telegram.org/...');

// ✅ OK — IPv4 강제
https.get(url, { family: 4 }, callback);
```

**Node.js v22의 기본 DNS 순서가 IPv6 우선** → Telegram API가 IPv6 응답 안 함 → ETIMEDOUT.

`curl`은 시스템 resolver(IPv4 우선)를 사용해서 문제 없었음.

### 5단계: `dns.setDefaultResultOrder('ipv4first')` 시도

ESM에서 `import` 호이스팅 때문에 런타임 호출이 너무 늦음 → 여전히 실패.

### 6단계: `net.setDefaultAutoSelectFamily(true)` 시도

openclaw-ref의 `fetch.ts`에서 발견. 하지만 Node.js native fetch(undici)는 `net` 모듈 설정을 **무시**함 → 실패.

### 7단계: 최종 해결 — 커스텀 IPv4 fetch 래퍼

`https.Agent({family: 4})`를 사용한 fetch 함수를 직접 만들어서 grammy의 `client.fetch`에 주입:

```js
const ipv4Agent = new https.Agent({ family: 4 });
const ipv4Fetch = (url, init = {}) => {
    return new Promise((resolve, reject) => {
        const u = new URL(url);
        const req = https.request({ ...opts, agent: ipv4Agent }, (res) => {
            // ... Response 객체 구성
        });
    });
};
const bot = new Bot(token, { client: { fetch: ipv4Fetch } });
```

**결과**: `[tg] ✅ @Clawcli_bot polling active` ✅

## 시도한 것들 (실패 목록)

| 시도                                   | 결과          |
| -------------------------------------- | ------------- |
| `apiThrottler()` 순서 변경             | ❌             |
| `bot.init()` 분리                      | ❌ hang        |
| `--dns-result-order=ipv4first`         | ❌ undici 무시 |
| `net.setDefaultAutoSelectFamily(true)` | ❌ undici 무시 |
| `node-fetch` 패키지                    | ❌ ETIMEDOUT   |

## 최종 커밋

- `c4bdcba` — custom IPv4 fetch wrapper for grammy
