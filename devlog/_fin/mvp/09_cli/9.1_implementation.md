---
created: 2026-02-23
tags: [cli-claw, CLI, phase-9]
aliases: [Phase 9 구현 로그]
---

# Phase 9: CLI 패키징 구현 기록

Phase 9에서 cli-claw를 배포 가능한 CLI 도구로 만들었다. 서브커맨드 구조로 `serve`, `init`, `doctor`, `chat`, `status`를 구현, 경로를 `~/.cli-claw/`로 정규화하고, WebSocket 기반 터미널 채팅을 추가했다.

---

## 9.1 엔트리포인트 + serve

**파일**: `bin/cli-claw.js`, `bin/commands/serve.js`

- `cli-claw.js`: subcommand 라우터 (`serve|init|doctor|chat|status|--help|--version`)
- `serve.js`: `server.js`를 foreground child process로 spawn
  - signal forwarding (SIGINT/SIGTERM)
  - `--port`, `--host`, `--open` (macOS `open` 명령)
- **버그 수정**: `join(__dirname, '..', 'server.js')` → `'..', '..', 'server.js'`
  - 원인: `serve.js`가 `bin/commands/`에 있어서 2단계 올라가야 프로젝트 루트

## 9.2 경로 마이그레이션

**파일**: `server.js`

```diff
- const DB_PATH = join(__dirname, 'claw.db');
- const SETTINGS_PATH = join(__dirname, 'settings.json');
+ const DB_PATH = join(CLAW_HOME, 'claw.db');
+ const SETTINGS_PATH = join(CLAW_HOME, 'settings.json');
```

- 1회 자동 마이그레이션: legacy 파일 → `~/.cli-claw/` 복사
- WAL/SHM 파일도 함께 복사
- `.migrated-v1` marker로 중복 방지

## 9.3 init 마법사

**파일**: `bin/commands/init.js`

- Interactive readline: workingDir, CLI, permissions, Telegram, skillsDir
- `--non-interactive` + `--force` 플래그
- 기존 settings.json merge 보존
- 완료 후 `postinstall.js` symlink 자동 실행

## 9.4 doctor 진단

**파일**: `bin/commands/doctor.js`

7개 체크 항목:
1. `~/.cli-claw` writable
2. `settings.json` parse
3. `claw.db` 존재/크기
4. `heartbeat.json` (active jobs)
5. CLI 설치 (claude, codex, gemini, opencode)
6. Telegram token 형식
7. Skills symlink 상태

`--json` 출력, exit code 0(OK/WARN) / 1(ERROR)

## 9.5 chat + raw — 반복 개선 기록

**파일**: `bin/commands/chat.js`

### v1 (67466cd): ANSI 박스 배너

- 유니코드 박스 문자 (`╭╰│`) 사용한 배너
- `boxLine()` 함수로 패딩 계산
- **문제**: 이모지 + 유니코드 폭 계산 실패 → 박스 오른쪽 테두리 어긋남

### v2 (0402311): bordered input box

- `┌─ message ─┐` 스타일 입력 박스 시도
- **문제**: 여전히 유니코드 박스 문자가 터미널에서 2칸 폭 렌더링 → 깨짐

### v3 (72e9604): ASCII 대시 + Claude Code 스타일

- 유니코드 `─` (U+2500) → ASCII `-` 로 전환
- 깨짐 해결, but 아래선이 입력 전에 안 보임
- `showInput()`: 윗선만 그리고 프롬프트 대기
- `showInputBottom()`: 엔터 후에야 아래선 표시

**핵심 깨달음**: readline prompt는 출력의 맨 아래에 위치하므로, 아래에 미리 내용을 그리려면 ANSI 커서 조작 필요

### v4 (29fd0dd): ANSI 커서 trick 시도

- footer를 프롬프트 아래에 미리 출력 → `\x1b[1A\x1b[4C` 로 커서 되돌리기
- **문제**: readline의 내부 커서 추적과 충돌 → 입력 위치 꼬임

### v5 (38e720c): 단순 top/bottom + footer

- 복잡한 ANSI trick 포기
- 평범하게 입력 후 아래선 + footer 표시
- **문제**: 여전히 입력 전에는 아래선 안 보임 (사용자 불만)

### v6 (7ee3303 → 72c8d0b): cursor save/restore ✅ 최종

- `showInput()`:
  1. 윗선 출력
  2. 프롬프트 출력
  3. `\x1b[s` (커서 위치 저장)
  4. 아래선 + footer 출력 (미리 그림)
  5. `\x1b[u` (커서 복원 → 프롬프트 위치로 돌아감)

- `onInputDone()`:
  1. readline이 엔터 처리 후 커서가 입력 줄 끝에 위치
  2. `\n\x1b[2K` × 2 — 아래 2줄(아래선 + footer) 통과하면서 지우기
  3. 더 이상 `\x1b[s/u` 사용 안 함 (스크롤 시 깨짐 방지)

```
  --------------------------------------------------------
  ❯ 여기에 입력 (커서 여기)               ← \x1b[u 복원 지점
  --------------------------------------------------------  ← 미리 그려짐
  Claude Code  |  /quit  |  /clear         ← 미리 그려짐
```

### 동작 흐름

```
[시작] → showInput() → 3줄 그리기 + 커서 복원
   ↓
[사용자 입력] → readline 처리
   ↓
[엔터] → onInputDone() → 아래 2줄 지우기
   ↓
[서버 응답] → agent_chunk/agent_done 표시
   ↓
[완료] → showInput() → 다시 3줄 그리기 + 커서 복원
```

### v7 (04ce6d3): `--simple` 모드 추가

- 세 번째 모드 도입: `--simple` — ANSI 커서 조작 없이 깨끗한 텍스트 REPL
- `rl.prompt()` 기반 단순 입출력, 응답은 plain text streaming
- ANSI 미지원 터미널이나 디버깅용
- 기존 `--raw`는 ndjson 파이프 전용으로 유지

### v8 (8327b46): `--raw` UI 래핑 + 백스페이스 버그 fix ✅ 최종

**변경 1: `--raw` 모드에 배너/박스 UI 공유**

- 기존: `--raw`는 UI 없이 stdin → JSON stdout (불편)
- 변경: `--raw`도 default와 동일한 배너 + 입력 박스 사용, 응답만 dimmed JSON으로 표시
- 배너에 `(raw json)` 표시로 모드 구분
- default와 raw가 `else` 블록 하나로 통합, `isRaw` 플래그로 분기

```js
// raw: JSON 그대로
console.log(`  ${c.dim}${JSON.stringify(msg)}${c.reset}`);
// default: 포맷팅
process.stdout.write((msg.text || '').replace(/\n/g, '\n  '));
```

**변경 2: 백스페이스 프롬프트 삭제 버그**

- 증상: 글자 1개 입력 후 백스페이스 → `❯` 프롬프트까지 지워짐
- 원인: `process.stdout.write('❯ ')` 사용 → readline이 prompt 폭을 인식 못함
  - readline은 prompt 길이만큼 커서 좌측 이동을 제한하는데, 직접 write하면 길이 0으로 인식
- 해결: `rl.setPrompt(promptStr)` + `rl.prompt()` 사용

```diff
- process.stdout.write(`  ${accent}❯${c.reset} `);
+ rl.setPrompt(promptStr);
+ rl.prompt();
```

**변경 3: `setImmediate`로 bottom draw 타이밍**

- `rl.prompt()`가 prompt를 그린 후에 아래선 + footer를 그려야 함
- `setImmediate(() => { ... bottom hr + footer ... })` 으로 다음 tick에 그리기

### 최종 3-모드 구조

```
cli-claw chat            # 배너 + ANSI 박스 + 포맷팅 응답
cli-claw chat --raw      # 배너 + ANSI 박스 + dimmed JSON 응답
cli-claw chat --simple   # 한줄 헤더 + plain readline
```

### 남은 이슈

- `agent_status`의 `\r`이 프롬프트 줄과 겹칠 수 있음
- 긴 입력(줄바꿈)시 미리 그린 아래선이 밀릴 가능성
- 터미널 리사이즈 시 레이아웃 재계산 없음

## 9.6 패키징

**파일**: `package.json`

```json
"bin": { "cli-claw": "bin/cli-claw.js" },
"files": ["bin/", "server.js", "public/", "package.json"]
```

## WebSocket `send_message` 핸들러

**파일**: `server.js` 

```js
wss.on('connection', (ws) => {
    ws.on('message', (raw) => {
        const msg = JSON.parse(raw.toString());
        if (msg.type === 'send_message' && msg.text) {
            insertMessage.run('user', msg.text, 'cli', '');
            broadcast('new_message', { role: 'user', content: msg.text, source: 'cli' });
            orchestrate(msg.text);
        }
    });
});
```

## 커밋 이력

| 커밋      | 내용                                                            |
| --------- | --------------------------------------------------------------- |
| `6ace2d8` | Phase 9 전체 (serve, init, doctor, chat, status, migration, WS) |
| `132126d` | serve.js 경로 fix (`..` → `../..`)                              |
| `67466cd` | chat.js v1 — ANSI banner (유니코드 깨짐)                        |
| `0402311` | chat.js v2 — bordered input (여전히 깨짐)                       |
| `72e9604` | chat.js v3 — ASCII 대시 + gitignore 복구                        |
| `38e720c` | chat.js v5 — top/bottom hr + footer                             |
| `29fd0dd` | chat.js v4 — ANSI cursor trick (충돌)                           |
| `7ee3303` | chat.js v6 — cursor save/restore                                |
| `72c8d0b` | chat.js v6 fix — onInputDone advance                            |
| `04ce6d3` | chat.js v7 — `--simple` 모드 추가                               |
| `8327b46` | chat.js v8 — raw UI 래핑 + rl.setPrompt 백스페이스 fix          |
| `148b2bd` | chat.js v9 — raw stdin rewrite + --raw JSON fix ✅               |

## 변경 기록

- 2026-02-23: Phase 9 전체 구현 및 기록
- 2026-02-23: chat.js 9회 반복 개선 상세 기록

---

### v9 (148b2bd): raw stdin + persistent footer ✅ 최종

**근본 원인 발견**: readline이 키 입력마다 `\x1b[0J` (clear to end of screen) 실행 → 아래 그린 건 무조건 삭제됨. Claude Code/Codex/OpenCode는 **Ink (React for CLI)** 사용해서 가능한 것.

**해결: readline 제거, raw stdin으로 전환**

```js
process.stdin.setRawMode(true);
process.stdin.resume();
process.stdin.setEncoding('utf8');
```

수동 keypress 핸들링:
- `\r` / `\n`: Enter → 제출
- `\x7f` / `\b`: Backspace → `inputBuf.slice(0, -1)`
- `\x03`: Ctrl+C → exit
- `\x15`: Ctrl+U → 줄 전체 삭제
- `charCode >= 32 || > 127`: 인쇄 가능 문자 (한글 포함)

**`drawInputBox()`**: 
1. top hr
2. 프롬프트 + 커서 위치 저장 (`\x1b[s`)
3. bottom hr + footer 그리기
4. 커서 복원 (`\x1b[u`) → 사용자 입력 위치로 돌아감

**`redrawPromptLine()`**:
- `\r\x1b[2K` → 현재 줄만 지우고 다시 그리기
- 아래선/footer는 건드리지 않음 (readline과의 핵심 차이)

**`--raw` JSON 수정**:
- `data.toString()` (원본 JSON 문자열) 을 dimmed로 출력
- `isRaw` 분기에서 `break` 추가해서 default 포맷팅 방지

**`inputActive` 플래그**:
- 메시지 전송 후 `false` → 에이전트 응답 중 추가 입력 차단
- `agent_done` 수신 후 `true` → 입력 재활성화

