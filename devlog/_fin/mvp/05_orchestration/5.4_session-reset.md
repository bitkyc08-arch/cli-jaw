# Phase 5.4: B.md 변동 시 세션 리셋 + JSON 블록 스트립

## 1. 세션 리셋

### 문제

resume 모드 → `skipStdin` → 새 시스템 프롬프트 미반영.

### 해결

`regenerateB()` 안에서 session_id를 null로 리셋:

```js
function regenerateB() {
    fs.writeFileSync(join(PROMPTS_DIR, 'B.md'), getSystemPrompt());
    
    // 세션 무효화 — 다음 spawn은 새 세션으로 시작
    const session = getSession();
    if (session.session_id) {
        updateSession.run(session.active_cli, null, session.model,
            session.permissions, session.working_dir, session.effort);
        console.log('[claw:session] invalidated — B.md changed');
    }
}
```

## 2. JSON 코드블럭 스트립 (claw-lite L607-608)

### 문제

Planning Agent가 subtask JSON을 출력하면 사용자에게 raw JSON이 보임.

### 해결

DB 저장 + broadcast 전에 JSON 블록 제거:

```js
// spawnAgent close handler — DB 저장 전
const cleaned = ctx.fullText.replace(/```json\n[\s\S]*?\n```/g, '').trim();
// cleaned를 insertMessage + broadcast에 사용

// orchestrate() — r1.text에서도 strip
const displayText = r1.text.replace(/```json\n[\s\S]*?\n```/g, '').trim();
```

### 위치

| 위치                              | 적용                                    |
| --------------------------------- | --------------------------------------- |
| `spawnAgent` close handler        | `insertMessage`에 cleaned 저장          |
| `orchestrate` Planning Agent 응답 | subtask JSON 파싱 후 나머지만 broadcast |
| `finalizeAgent` (프론트엔드)      | 이중 안전장치로 프론트에서도 strip      |

## 체크리스트

- [ ] `regenerateB()` 세션 무효화
- [ ] `spawnAgent` close: JSON 블록 strip 후 저장
- [ ] `orchestrate`: Planning Agent 응답 strip 후 broadcast
- [ ] 프론트엔드 `renderMarkdown`에서 JSON 블록 제거
