# 12.1.2 에이전트 중단 + Steer (방향 전환)

## 아키텍처

```
Kill:   activeProcess.kill('SIGTERM') → 2초 후 SIGKILL fallback
Steer:  killActiveAgent() → waitForProcessEnd(3s) → orchestrate(새 프롬프트)
```

```
                    ┌─ CLI chat: ESC / Ctrl+C ──────────────────┐
                    │                                            │
User ──── Message ──┼─ Web UI: ■ Stop 버튼 ─────────────────────┤─→ killActiveAgent()
                    │                                            │      ↓ (2s timeout)
                    │                                            │   activeProcess = null
                    └─ Telegram: 새 메시지 ─────────────────────┘   broadcast('agent_status')
                         ↓ (auto-steer)
                    killActiveAgent() → wait → orchestrate(새 메시지)
```

---

## 채널별 동작

### CLI Chat (`chat.js`)

| 키              | 상황             | 동작                                       |
| --------------- | ---------------- | ------------------------------------------ |
| **ESC**         | 에이전트 실행 중 | WS `{ type: 'stop' }` → 에이전트 중단      |
| **Ctrl+C**      | 에이전트 실행 중 | WS `{ type: 'stop' }` → 에이전트 중단      |
| **Ctrl+C**      | idle (입력 대기) | 프로그램 종료 (`process.exit`)             |
| **텍스트 입력** | 에이전트 실행 중 | 허용됨 → Enter 시 steer (kill → 새 메시지) |

### Web UI (`index.html`)

| UI                      | 동작                                                            |
| ----------------------- | --------------------------------------------------------------- |
| **■ Stop 버튼**         | `POST /api/stop` → killActiveAgent                              |
| **Send 버튼 (실행 중)** | 기존 에이전트 steer → ↻ 아이콘 표시                             |
| **agent_status 수신**   | running: Stop 버튼 표시 + Send → ↻ / idle: Stop 숨김 + Send → ➤ |

> **변경점**: 실행 중에도 chatInput/btnSend `disabled=false` (steer 가능)

### Telegram

| 상황                         | 동작                                                             |
| ---------------------------- | ---------------------------------------------------------------- |
| 에이전트 idle                | 정상 실행                                                        |
| 에이전트 실행 중 + 새 메시지 | 자동 `killActiveAgent('telegram-steer')` → wait → 새 메시지 실행 |

---

## 서버 핵심 함수

```javascript
// Kill — SIGTERM, 2초 후 SIGKILL
function killActiveAgent(reason = 'user') {
    if (!activeProcess) return false;
    activeProcess.kill('SIGTERM');
    setTimeout(() => { if (!proc.killed) proc.kill('SIGKILL'); }, 2000);
    return true;
}

// Wait — activeProcess가 null 될 때까지 (최대 3초)
function waitForProcessEnd(timeoutMs = 3000) { ... }

// Steer — kill → wait → orchestrate
async function steerAgent(newPrompt, source) {
    killActiveAgent('steer');
    await waitForProcessEnd(3000);
    orchestrate(newPrompt);
}
```

## API

```
POST /api/stop              → killActiveAgent()
POST /api/message (busy)    → steerAgent() (기존 409 제거)
WS { type: 'stop' }        → killActiveAgent()
WS { type: 'send_message' } (busy) → steerAgent()
broadcast('agent_status', { running: bool, agentId, cli })
```

---

## 파일 변경

| 파일                   | 변경                                                                                                                       |
| ---------------------- | -------------------------------------------------------------------------------------------------------------------------- |
| `server.js`            | killActiveAgent, steerAgent, waitForProcessEnd, POST /api/stop, WS stop/steer, agent_status broadcast, Telegram auto-steer |
| `public/index.html`    | ■ Stop 버튼, setStatus에서 입력 허용 + ↻ steer 아이콘, agent_status 양쪽 포맷                                              |
| `bin/commands/chat.js` | ESC → stop, Ctrl+C → stop/exit, 실행 중 입력 허용                                                                          |

## 검증

```
✅ killActiveAgent 함수 존재
✅ steerAgent 함수 존재
✅ waitForProcessEnd 함수 존재
✅ POST /api/stop 엔드포인트
✅ WS 'stop' 핸들러
✅ agent_status broadcast (spawnAgent + close)
✅ Telegram auto-steer
✅ ESC/Ctrl+C stop 핸들러
✅ 실행 중 입력 허용 (steer)
✅ ■ Stop 버튼 + stopAgent()
✅ ↻ Steer 아이콘
```
