# Phase 8.3: Symlink & Skills 인프라

---

## 개요

claw 설치 시 `workingDir`에 에이전트 도구들이 필요로 하는 **숨김 폴더 구조를 자동 생성** (symlink 기반). 스킬 원본은 한 곳에만 두고, 나머지는 symlink로 연결.

---

## 설치 시 생성할 구조

```
{workingDir}/                         ← settings.workingDir (기본: ~)
├── .agents/
│   └── skills/ → {skillsSource}      ← symlink (원본 스킬 위치)
├── .agent/
│   └── skills → ../.agents/skills    ← symlink (호환용)
├── .gemini/ → (기존 유지)            ← Gemini/Antigravity 설정
├── .claude.json → (기존 유지)        ← Claude MCP 설정
├── .codex/ → (기존 유지)             ← Codex 설정
├── AGENTS.md                         ← 에이전트 룰 (있으면 유지)
└── CLAUDE.md → AGENTS.md             ← symlink (호환용)
```

### skillsSource 결정 순서

1. `settings.skillsDir` 에 명시된 경로 (사용자 지정)
2. `{workingDir}/.agents/skills/` 가 이미 있으면 그대로 사용
3. 없으면 `~/.cli-claw/skills/` 생성 후 연결

---

## npm 설치 스크립트 (postinstall)

```js
// bin/postinstall.js
import fs from 'fs';
import path from 'path';
import os from 'os';

const home = os.homedir();
const clawDir = path.join(home, '.cli-claw');
const defaultSkillsDir = path.join(clawDir, 'skills');

// 1. ~/.cli-claw/ 기본 디렉토리 생성
fs.mkdirSync(clawDir, { recursive: true });
fs.mkdirSync(defaultSkillsDir, { recursive: true });

// 2. symlink 생성 (이미 존재하면 skip)
function ensureSymlink(target, linkPath) {
    if (fs.existsSync(linkPath)) return;
    fs.mkdirSync(path.dirname(linkPath), { recursive: true });
    fs.symlinkSync(target, linkPath);
    console.log(`[claw] symlink: ${linkPath} → ${target}`);
}

// .agents/skills → skillsSource
const agentsSkills = path.join(home, '.agents', 'skills');
if (!fs.existsSync(agentsSkills)) {
    ensureSymlink(defaultSkillsDir, agentsSkills);
}

// .agent/skills → .agents/skills
ensureSymlink(
    path.join(home, '.agents', 'skills'),
    path.join(home, '.agent', 'skills')
);

// CLAUDE.md → AGENTS.md (없을 때만)
const agentsMd = path.join(home, 'AGENTS.md');
const claudeMd = path.join(home, 'CLAUDE.md');
if (fs.existsSync(agentsMd) && !fs.existsSync(claudeMd)) {
    ensureSymlink(agentsMd, claudeMd);
}
```

---

## 프롬프팅: 원본만 수정하도록

시스템 프롬프트에 추가:

```
## Skills
스킬 파일은 반드시 원본 위치에서 편집하세요:
- 원본: {skillsDir}/
- 심링크는 편집 금지: .agents/skills/, .agent/skills/
```

이렇게 하면 Claude/Codex가 심링크를 따라가지 않고 원본만 수정.

---

## Settings

```json
{
  "skillsDir": "~/.cli-claw/skills",
  "workingDir": "~"
}
```

- `skillsDir`만 바꾸면 모든 symlink가 자동 갱신
- 향후 Phase 9 (CLI) `npx claw init` 마법사에서 설정

---

## 체크리스트

- [ ] 8.3.1 `bin/postinstall.js` — symlink 자동 생성
- [ ] 8.3.2 `settings.skillsDir` 설정 + symlink 갱신 로직
- [ ] 8.3.3 시스템 프롬프트에 스킬 원본 경로 주입
- [ ] 8.3.4 package.json에 `postinstall` 스크립트 등록

## 수정 대상

| 파일                 | 변경                                  |
| -------------------- | ------------------------------------- |
| `bin/postinstall.js` | [NEW] symlink 생성 스크립트           |
| `package.json`       | `scripts.postinstall` 추가            |
| `server.js`          | skillsDir 읽기 + 시스템 프롬프트 주입 |
