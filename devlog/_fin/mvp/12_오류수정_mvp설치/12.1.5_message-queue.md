# 12.1.5 ë©”ì‹œì§€ í ì‹œìŠ¤í…œ

## ë¬¸ì œ

í˜„ì¬: ì—ì´ì „íŠ¸ ì‹¤í–‰ ì¤‘ ìƒˆ ë©”ì‹œì§€ â†’ 409 ê±°ë¶€ ë˜ëŠ” ë¬´ì‹œë¨.
ì›í•˜ëŠ” ë™ì‘: ì—ì´ì „íŠ¸ ì‹¤í–‰ ì¤‘ ìƒˆ ë©”ì‹œì§€ â†’ **íì— ëŒ€ê¸°** â†’ í˜„ì¬ ì‘ì—… ëë‚˜ë©´ ìë™ ì‹¤í–‰.

## ì„¤ê³„

```
User â”€â”€â†’ [Message Queue] â”€â”€â†’ agent idle? â”€â”€â†’ spawnAgent(queued)
              â”‚                    â”‚
              â”œâ”€ msg 1             â”œâ”€ yes â†’ ë°”ë¡œ ì‹¤í–‰
              â”œâ”€ msg 2             â””â”€ no  â†’ í ëŒ€ê¸° (ëë‚˜ë©´ ìë™ êº¼ëƒ„)
              â””â”€ msg 3
```

### í•µì‹¬ êµ¬ì¡°

```javascript
const messageQueue = [];  // ëŒ€ê¸° ì¤‘ì¸ ë©”ì‹œì§€

function enqueueMessage(prompt, source) {
    messageQueue.push({ prompt, source, ts: Date.now() });
    console.log(`[queue] +1 (${messageQueue.length} pending)`);
    broadcast('queue_update', { pending: messageQueue.length });
}

function processQueue() {
    if (activeProcess || messageQueue.length === 0) return;
    // ë‘ ê°œ ì´ìƒì´ë©´ í•œë²ˆì— í•©ì³ì„œ ë³´ë‚´ê¸°
    const batched = messageQueue.splice(0);  // ì „ë¶€ êº¼ëƒ„
    const combined = batched.map(m => m.prompt).join('\n\n---\n\n');
    const source = batched[batched.length - 1].source;
    insertMessage.run('user', combined, source, '');
    broadcast('new_message', { role: 'user', content: combined, source });
    orchestrate(combined);
}
```

### child.on('close') ìˆ˜ì •

```diff
  child.on('close', (code) => {
      activeProcess = null;
      broadcast('agent_status', { running: false });
+     // íì— ëŒ€ê¸° ì¤‘ì¸ ë©”ì‹œì§€ ì²˜ë¦¬
+     processQueue();
  });
```

### ì±„ë„ë³„ ë³€ê²½

| ì±„ë„         | ë³€ê²½                              |
| ------------ | --------------------------------- |
| **HTTP**     | 409 â†’ `enqueueMessage()` + 200    |
| **WS**       | busyë©´ `enqueueMessage()`         |
| **Web UI**   | ì…ë ¥ í™œì„±í™”, í ì¹´ìš´í„° í‘œì‹œ       |
| **CLI**      | ì…ë ¥ í™œì„±í™”, ëŒ€ê¸° í‘œì‹œ            |
| **Telegram** | í˜„ì¬ ìœ ì§€ (fire-and-forget steer) |

### Web UI

```
Running: [ğŸ“] [__ì…ë ¥ ê°€ëŠ¥__] [â–  Stop]
                                  â””â”€ íì— 2ê°œ ëŒ€ê¸° ì¤‘ (â³2)
```

### í ë°°ì¹­ ë¡œì§

```
íì— 3ê°œ ìŒ“ì„:
  "í‘œ ë§Œë“¤ì–´ì¤˜"
  "CSVë¡œ ë³€í™˜"  
  "íŒŒì¼ë¡œ ì €ì¥"

â†’ í•©ì³ì„œ ë³´ëƒ„:
  "í‘œ ë§Œë“¤ì–´ì¤˜\n\n---\n\n CSVë¡œ ë³€í™˜\n\n---\n\nQ íŒŒì¼ë¡œ ì €ì¥"
```

## íŒŒì¼ ë³€ê²½

| íŒŒì¼         | ë³€ê²½                                                                  |
| ------------ | --------------------------------------------------------------------- |
| `server.js`  | messageQueue + enqueueMessage + processQueue + child.on('close') ìˆ˜ì • |
| `index.html` | ì…ë ¥ í™œì„±í™” + í ì¹´ìš´í„° í‘œì‹œ + queue_update ì´ë²¤íŠ¸                    |
| `chat.js`    | ì…ë ¥ í™œì„±í™” + ëŒ€ê¸° í‘œì‹œ                                               |

## ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] server.js â€” messageQueue + enqueueMessage + processQueue
- [ ] server.js â€” HTTP/WS busy ì‹œ enqueueMessage
- [ ] server.js â€” child.on('close')ì—ì„œ processQueue
- [ ] server.js â€” broadcast('queue_update')
- [ ] index.html â€” ì…ë ¥ í™œì„±í™” + í ì¹´ìš´í„°
- [ ] chat.js â€” ì…ë ¥ í™œì„±í™” + ëŒ€ê¸° í‘œì‹œ
- [ ] í…ŒìŠ¤íŠ¸
