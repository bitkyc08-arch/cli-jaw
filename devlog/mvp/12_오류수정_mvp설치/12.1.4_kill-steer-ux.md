# 12.1.4 Kill/Steer UX 수정

## 리서치 결과

### grammY Blocking 문제 (context7 검증)

grammY의 `bot.start()` (long polling)는 **순차 처리** — 현재 핸들러의 `await`가 끝날 때까지 다음 update를 처리하지 않음.

```
현재: bot.start() → bot.on('message:text', async (ctx) => {
         await tgOrchestrate();  ← 이 await가 끝날 때까지 다음 메시지 block
      })
```

**해결 옵션 2가지:**

| 방식                      | 변경                                               | 장단점                                 |
| ------------------------- | -------------------------------------------------- | -------------------------------------- |
| **A. `await` 제거**       | `tgOrchestrate(ctx, text, text)` (fire-and-forget) | 간단, 에러 핸들링 직접 필요            |
| **B. `@grammyjs/runner`** | `run(bot)` + `sequentialize()`                     | 공식 방식, 동시처리 + 채팅별 순서 보장 |

> **옵션 A 채택 (간단)**: tgOrchestrate 안에 이미 try/catch/reply 있으므로 fire-and-forget 가능. runner 추가 의존성 불필요.

> 출처: [grammY Runner Plugin](https://github.com/grammyjs/website/blob/main/site/docs/plugins/runner.md)

### Web UI 현재 상태 (브라우저 검증)

![Web UI 현재 상태](file:///Users/jun/.gemini/antigravity/brain/cf48d97f-7ef5-4946-a415-a7a3422cd1e7/chat_input_test_1771822094447.png)

**확인 사항:**
- `btnSend` (➤) 보임 — 주황색 원형 버튼
- `btnStop` (■) hidden — DOM에 존재하나 `display:none`
- idle 상태에서 입력 가능 ✅
- **문제**: running 시 btnSend ↻ + btnStop이 별도로 나타남 → 유저 요청은 **하나의 버튼**으로 전환

---

## 수정 계획

### 채널별 UX (최종)

| 채널         | 중단 (Kill only)                | Steer (Kill→Redirect)  |
| ------------ | ------------------------------- | ---------------------- |
| **Web**      | Send 버튼 → ■ Stop으로 **교체** | 텍스트 + Enter         |
| **CLI**      | ESC / Ctrl+C                    | 텍스트 + Enter         |
| **Telegram** | —                               | 새 메시지 = 자동 steer |

### A. server.js — Telegram fix

```diff
  bot.on('message:text', async (ctx) => {
      const text = ctx.message.text;
      if (text.startsWith('/')) return;
      console.log(`[tg:in] ${ctx.chat.id}: ${text.slice(0, 80)}`);
-     await tgOrchestrate(ctx, text, text);
+     tgOrchestrate(ctx, text, text);  // fire-and-forget → steer 가능
  });
```

photo/document 핸들러도 동일 적용.

### B. index.html — Send/Stop 하나의 버튼

**btnStop 삭제**, `btnSend` 하나로 상태 전환:

```javascript
function setStatus(s) {
    agentBusy = s === 'running';
    const btn = document.getElementById('btnSend');
    if (agentBusy) {
        btn.textContent = '■';
        btn.title = '중단';
        btn.style.background = '#e55';
        btn.onclick = stopAgent;       // 클릭 = 중단만
    } else {
        btn.textContent = '➤';
        btn.title = 'Send';
        btn.style.background = '';
        btn.onclick = sendMessage;     // 클릭 = 전송
    }
}
```

`handleKey(Enter)`:
- 텍스트 있으면 → `sendMessage()` (서버가 busy면 steer 처리)
- 텍스트 없으면 → 무시

> Enter+텍스트 = steer, ■ 버튼 = stop (텍스트 무시하고 중단만)

### C. chat.js — 이미 OK

현재 구현 유지:
- ESC / Ctrl+C (에이전트 실행 중) → WS `{ type: 'stop' }` = 중단만
- 텍스트 + Enter (에이전트 실행 중) → WS `send_message` → 서버가 steer 처리

---

## 파일 변경

| 파일         | 변경                                                                         |
| ------------ | ---------------------------------------------------------------------------- |
| `server.js`  | bot.on handler: `await` 제거 (text, photo, document 3곳)                     |
| `index.html` | btnStop 삭제, btnSend를 onclick 교체 방식으로 Stop/Send 전환, setStatus 수정 |

## 체크리스트

- [ ] server.js — Telegram `await` 제거 (3곳)
- [ ] index.html — btnStop 제거 + btnSend Stop/Send 전환
- [ ] 테스트: Web 중단 + Telegram steer
- [ ] 문서화
